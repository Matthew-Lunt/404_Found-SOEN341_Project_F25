<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Payment</title>
    <link rel="stylesheet" href="css/homepage.css">
</head>
<body class="bg-light">

<header>
    <div class="container header-content">
        <h1 class="logo"><a href="index.html">404TicketsFound</a></h1>
        <nav>
            <a href="SearchResults.html">Search</a>
            <a href="AddFriend.html">Add Friend</a>
        </nav>
    </div>
</header>

<div class="container my-5">
    <div class="card shadow-sm">
        <div class="card-body">
            <h2 class="card-title text-center mb-4">Ticket Payment</h2>

            <div class="mb-4">
                <h5>Event Summary</h5>
                <ul class="list-group">
                    <li class="list-group-item"><strong>Event:</strong> <span id="eventName">—</span></li>
                    <li class="list-group-item"><strong>Price:</strong> <span id="ticketPrice">—</span></li>
                </ul>
            </div>

            <form id="paymentForm">
                <div class="mb-3">
                    <label for="price" class="form-label">Price of Event</label>
                    <input type="text" class="form-control" id="price" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Confirm Payment</button>
            </form>

        </div>
    </div>
</div>

<footer>
    <p style="text-align:center;margin:28px 0;color:#777">&copy; 2025 404TicketsFound. All rights reserved.</p>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, doc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
        authDomain: "found-5ecc0.firebaseapp.com",
        projectId: "found-5ecc0",
        storageBucket: "found-5ecc0.appspot.com",
        messagingSenderId: "160156481057",
        appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    let eventName = params.get('event');
    let ticketPrice = params.get('price');
    let ticketType = params.get('type');

    if (!eventName) {
        const ticket = JSON.parse(localStorage.getItem('selectedTicket') || '{}');
        eventName = ticket.event;
        ticketPrice = ticket.price;
        ticketType = ticket.type;
    }

    eventName = eventName || 'Unknown Event';
    ticketPrice = Number(ticketPrice) || 0;
    ticketType = ticketType || 'PAID';

    document.getElementById('eventName').textContent = eventName;
    document.getElementById('ticketPrice').textContent = ticketType.toUpperCase() === 'FREE' ? 'Free' : `$${ticketPrice}`;

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const enteredPrice = Number(document.getElementById('price').value);

        if (isNaN(enteredPrice)) {
            alert('Please enter a valid price.');
            return;
        }

        if (enteredPrice !== ticketPrice) {
            alert(`Entered price does not match the ticket price of $${ticketPrice}.`);
            return;
        }

        // Save ticket in localStorage
        const ticketRecord = {
            event: eventName,
            price: ticketPrice,
            type: ticketType,
            id: Date.now().toString(36) + Math.random().toString(36).substring(2, 8)
        };
        localStorage.setItem('selectedTicket', JSON.stringify(ticketRecord));

        // Add event to user's "eventsAttended" array in Firestore
        const user = auth.currentUser;
        if (user) {
            const userRef = doc(db, "Users", user.uid);
            try {
                await updateDoc(userRef, {
                    eventsAttended: arrayUnion({
                        event: eventName,
                        price: ticketPrice,
                        type: ticketType,
                        timestamp: new Date().toISOString()
                    })
                });
                console.log('Event added to user record.');
            } catch (err) {
                console.error('Error updating user events:', err);
            }
        } else {
            console.warn('User not logged in, skipping Firestore update.');
        }

        // Redirect to confirmation page
        location.href = `ticket-confirmation.html?event=${encodeURIComponent(eventName)}&type=${ticketType}`;
    });
</script>

</body>
</html>
