<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Event Analytics – 404TicketsFound</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="homepage.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body{background:#f7f7f9}
    header .logo{font-weight:800}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0 18px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .k{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06);text-align:center}
    .k h4{margin:0;color:#7a2b3d;font-size:0.95rem}
    .k p{margin:6px 0 0;font-size:1.4rem}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:16px}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06)}
    .tools{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:16px;margin-top:16px}
    .table{overflow:auto;max-height:380px;border:1px solid #eee;border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .badge{padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .b-issued{background:#eef;color:#1b3a8a}
    .b-in{background:#def7e0;color:#236b2a}
    .btn{background:#7a2b3d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    input,select{padding:9px;border:1px solid #ddd;border-radius:10px;background:#fff}
    canvas{max-width:100%;border:1px dashed #ddd;border-radius:8px}
    .hint{color:#666;font-size:.9rem}
    nav a.active{font-weight:700}
  </style>
</head>
<body>
<script>
  const auth = JSON.parse(localStorage.getItem('auth')||'null');
  if(!auth || auth.role!=='organizer') location.href='404NotFoundLogin.html?reason=organizer_only';
</script>

<header>
  <div class="container header-content">
    <h1 class="logo">404TicketsFound</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="SearchResults.html">Search</a>
      <a href="CreateEvent.html">Create Event</a>
      <a class="active" href="EventAnalytics.html">Event Analytics</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <h2>Event Analytics</h2>

  <div class="bar">
    <label>Event
      <select id="ev"></select>
    </label>
    <label>Date
      <input type="date" id="day">
    </label>
    <button class="btn" id="clear">Clear</button>
  </div>

  <div class="kpis">
    <div class="k"><h4>Tickets Issued</h4><p id="kIssued">0</p></div>
    <div class="k"><h4>Checked In</h4><p id="kIn">0</p></div>
    <div class="k"><h4>Attendance Rate</h4><p id="kRate">0%</p></div>
    <div class="k"><h4>Remaining Capacity</h4><p id="kLeft">—</p></div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 style="margin:0 0 8px">Ticketing Over Time</h3>
      <canvas id="c1" height="160"></canvas>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Check-ins Over Time</h3>
      <canvas id="c2" height="160"></canvas>
    </div>
  </div>

  <div class="tools">
    <div class="card">
      <h3 style="margin:0 0 8px">Export Attendees (CSV)</h3>
      <button class="btn" id="csv">Export CSV</button>
      <p class="hint" style="margin-top:8px">Exports the current event + date filter.</p>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px">QR Validator (upload image)</h3>
      <input type="file" id="qrFile" accept="image/*"/>
      <canvas id="qrCanvas" width="320" height="320" style="display:none"></canvas>
      <div id="qrOut" class="hint" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">Attendees</h3>
    <div class="table">
      <table id="tbl">
        <thead><tr><th>Code</th><th>Event</th><th>Status</th><th>Issued</th><th>Checked In</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<footer><p style="text-align:center;margin:28px 0;color:#777">&copy; 2025 404TicketsFound</p></footer>

<script>
  const get = (k,f='[]') => JSON.parse(localStorage.getItem(k)||f);
  const set = (k,v) => localStorage.setItem(k,JSON.stringify(v));
  if(!localStorage.getItem('eventsCatalog')){
    set('eventsCatalog',[
      {title:'Rock Concert',date:'2025-10-15',capacity:500},
      {title:'Food Festival',date:'2025-11-02',capacity:1200},
      {title:'Hockey Game',date:'2025-12-12',capacity:900},
      {title:'Basketball Match',date:'2025-10-28',capacity:850},
      {title:'Jazz Night',date:'2025-11-18',capacity:400},
      {title:'Winter Carnival',date:'2025-12-05',capacity:3000},
    ]);
  }
  if(!localStorage.getItem('attendees')) set('attendees',[]);

  const evSel = document.getElementById('ev');
  const day = document.getElementById('day');
  const clearBtn = document.getElementById('clear');
  const kIssued = document.getElementById('kIssued');
  const kIn = document.getElementById('kIn');
  const kRate = document.getElementById('kRate');
  const kLeft = document.getElementById('kLeft');
  const tbody = document.querySelector('#tbl tbody');
  const btnCsv = document.getElementById('csv');
  let chart1, chart2;

  function eventsList(){
    const cat = get('eventsCatalog','[]');
    const att = get('attendees','[]');
    const map = new Map(cat.map(e=>[e.title,e]));
    att.forEach(a=>{ if(!map.has(a.event)) map.set(a.event,{title:a.event,date:a.eventDate||'',capacity:null}); });
    return [...map.values()].sort((a,b)=>a.title.localeCompare(b.title));
  }
  function capOf(name){ const e=get('eventsCatalog','[]').find(x=>x.title===name); return e?.capacity??null }
  function dateOf(name){ const e=get('eventsCatalog','[]').find(x=>x.title===name); return e?.date??'' }

  function buildSelect(){
    evSel.innerHTML = '<option value="">— Select an event —</option>' +
      eventsList().map(e=>`<option value="${e.title}">${e.title}</option>`).join('');
  }
  buildSelect();

  function fmt(t){ if(!t) return ''; const d=new Date(t); return d.toLocaleString() }
  function destroyCharts(){ chart1?.destroy(); chart2?.destroy(); chart1=chart2=null }

  function render(){
    const name = evSel.value;
    if(!name){ tbody.innerHTML=''; kIssued.textContent='0'; kIn.textContent='0'; kRate.textContent='0%'; kLeft.textContent='—'; destroyCharts(); return }
    const all = get('attendees','[]').filter(a=>a.event===name);
    const f = day.value ? all.filter(a=>(a.eventDate||'').startsWith(day.value)) : all;

    const issued = f.length;
    const checked = f.filter(a=>a.status==='checked_in').length;
    const rate = issued? Math.round(100*checked/issued):0;
    const left = capOf(name)!=null ? Math.max(capOf(name)-issued,0) : '—';
    kIssued.textContent=issued; kIn.textContent=checked; kRate.textContent=rate+'%'; kLeft.textContent=left;

    tbody.innerHTML = f.map(a=>`
      <tr>
        <td style="font-family:ui-monospace,monospace">${a.code}</td>
        <td>${a.event}</td>
        <td>${a.status==='checked_in'
              ? '<span class="badge b-in">Checked-in</span>'
              : '<span class="badge b-issued">Issued</span>'}</td>
        <td>${fmt(a.tsIssued)}</td>
        <td>${fmt(a.tsCheckedIn)}</td>
      </tr>`).join('') || `<tr><td colspan="5" class="hint">No attendees.</td></tr>`;

    const buckets = (list, tsKey)=>list.reduce((m,a)=>{
      const t=a[tsKey]; if(!t) return m; const d=new Date(t).toISOString().slice(0,10); m[d]=(m[d]||0)+1; return m
    },{});
    const iB = buckets(f,'tsIssued'), cB = buckets(f.filter(x=>x.status==='checked_in'),'tsCheckedIn');
    const lab1 = Object.keys(iB).sort(), dat1 = lab1.map(k=>iB[k]);
    const lab2 = Object.keys(cB).sort(), dat2 = lab2.map(k=>cB[k]);

    destroyCharts();
    chart1 = new Chart(document.getElementById('c1'),{type:'line',data:{labels:lab1,datasets:[{label:'Issued',data:dat1,tension:.3,fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
    chart2 = new Chart(document.getElementById('c2'),{type:'line',data:{labels:lab2,datasets:[{label:'Checked-in',data:dat2,tension:.3,fill:true}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
  }

  evSel.onchange=render; day.onchange=render; clearBtn.onclick=()=>{day.value=''; render()}

  btnCsv.onclick = ()=>{
    const name = evSel.value; if(!name) return alert('Pick an event first.');
    const rows = [['Event','Code','Status','Issued At','Checked In At','Event Date','Capacity']];
    const list = get('attendees','[]').filter(a=>a.event===name && (!day.value || (a.eventDate||'').startsWith(day.value)));
    list.forEach(a=>rows.push([a.event,a.code,a.status,fmt(a.tsIssued),fmt(a.tsCheckedIn),a.eventDate||'',capOf(a.event)??'']));
    const csv = rows.map(r=>r.map(v=>/[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv;charset=utf-8'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=(name.replace(/\s+/g,'_'))+'_attendees.csv'; a.click(); URL.revokeObjectURL(url);
  };

  // QR via image upload
  const file = document.getElementById('qrFile'), cvs=document.getElementById('qrCanvas'), ctx=cvs.getContext('2d'), out=document.getElementById('qrOut');
  file.onchange = e=>{
    out.textContent=''; const f=e.target.files?.[0]; if(!f) return;
    const img=new Image();
    img.onload=()=>{
      const s=Math.min(320/img.width,320/img.height), w=Math.floor(img.width*s), h=Math.floor(img.height*s);
      cvs.width=w; cvs.height=h; ctx.drawImage(img,0,0,w,h); cvs.style.display='block';
      const d=ctx.getImageData(0,0,w,h); const qr=jsQR(d.data,w,h);
      if(qr?.data) validate(qr.data); else out.textContent='No QR found. Try a clearer image.';
    };
    img.onerror=()=>out.textContent='Could not read image.'; img.src=URL.createObjectURL(f);
  };

  function validate(text){
    const name = evSel.value; if(!name) return out.textContent='Select an event first.';
    const list = get('attendees','[]'); let i = list.findIndex(a=>a.event===name && (a.code===text));
    if(i<0 && text.startsWith('TICKET-')) i=list.findIndex(a=>a.event===name && a.code===text);
    if(i<0) return out.innerHTML=`❌ Not found for this event.<br><span class="hint"><code>${text}</code></span>`;
    if(list[i].status==='checked_in') return out.innerHTML=`⚠️ Already checked in at ${fmt(list[i].tsCheckedIn)}`;
    list[i].status='checked_in'; list[i].tsCheckedIn=Date.now(); set('attendees',list);
    out.innerHTML='✅ Valid – check-in recorded.'; render();
  }

  // support 
  const p=new URLSearchParams(location.search); const ev=p.get('event'); if(ev){ const id=setInterval(()=>{ if(evSel.options.length){evSel.value=ev; clearInterval(id); render()} },40) }
</script>
</body>
</html>