<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Organizer Dashboard – 404TicketsFound</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="css/homepage.css"/>
  <style>
    body{background:#f7f8fb}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #ddd;border-radius:10px;padding:10px 14px;background:#fff;cursor:pointer}
    .tab.active{background:#7a2b3d;color:#fff;border-color:#7a2b3d}
    .panel{margin-top:16px}
    .hidden{display:none}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0 18px}
    select,input{padding:9px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .btn{background:#7a2b3d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .k{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06);text-align:center}
    .k h4{margin:0;color:#7a2b3d;font-size:.95rem}
    .k p{margin:6px 0 0;font-size:1.4rem}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06)}
    .table{overflow:auto;max-height:420px;border:1px solid #eee;border-radius:10px;margin-top:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .badge{padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .b-issued{background:#eef;color:#1b3a8a}
    .b-in{background:#def7e0;color:#236b2a}
    iframe{width:100%;border:0;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06);background:#fff}
  </style>
</head>
<body>
<script>
  const auth = JSON.parse(localStorage.getItem('auth')||'null');
  if(!auth || auth.role!=='organizer') location.href='404NotFoundLogin.html?reason=organizer_only';
</script>

<header>
  <div class="container header-content">
    <h1 class="logo">404TicketsFound</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="SearchResults.html">Search</a>
      <a href="CreateEvent.html">Create Event</a>
      <a class="active" href="organizer.html">Organizer Dashboard</a>
    </nav>
  </div>
</header>

<div class="wrap">
  <h2>Organizer Dashboard</h2>

  <div class="tabs">
    <button class="tab active" data-tab="analytics">Event Analytics</button>
    <button class="tab" data-tab="checker">Ticket Validity</button>
  </div>

  <!-- ANALYTICS -->
  <section id="analytics" class="panel">
    <div class="bar">
      <label>Event
        <select id="evA"></select>
      </label>
      <label>Date
        <input type="date" id="dayA"/>
      </label>
      <button class="btn" id="clearA">Clear</button>
      <button class="btn" id="csvA">Export Attendees (CSV)</button>
    </div>

    <div class="kpis">
      <div class="k"><h4>Tickets Issued</h4><p id="kIssued">0</p></div>
      <div class="k"><h4>Checked In</h4><p id="kIn">0</p></div>
      <div class="k"><h4>Attendance Rate</h4><p id="kRate">0%</p></div>
      <div class="k"><h4>Remaining Capacity</h4><p id="kLeft">—</p></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Attendees</h3>
      <div class="table">
        <table id="tblA">
          <thead><tr><th>Code</th><th>Event</th><th>Status</th><th>Issued</th><th>Checked In</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CHECKER (embed TicketValidity) -->
  <section id="checker" class="panel hidden">
    <div class="bar" style="justify-content:space-between;align-items:center">
      <div><strong>Ticket Validity</strong> (embedded)</div>
      <a class="btn" href="TicketValidity.html" target="_blank">Open Full Page</a>
    </div>
    <iframe id="checkerFrame" src="TicketValidity.html" title="Ticket Validity"></iframe>
  </section>
</div>

<footer><p style="text-align:center;margin:28px 0;color:#777">&copy; 2025 404TicketsFound</p></footer>

<script>
  document.querySelector('.tabs').addEventListener('click', e=>{
    if(!e.target.matches('.tab')) return;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    e.target.classList.add('active');
    const id=e.target.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if(id==='analytics') renderAnalytics();
    if(id==='checker') resizeFrame();
  });

  const frame=document.getElementById('checkerFrame');
  function resizeFrame(){
    try{
      const h = frame.contentDocument?.body?.scrollHeight || 900;
      frame.style.height = Math.max(h, 900)+'px';
    }catch(_){ frame.style.height='900px' }
  }
  frame.addEventListener('load', resizeFrame);

  const get=(k,f='[]')=>JSON.parse(localStorage.getItem(k)||f);
  const set=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  if(!localStorage.getItem('eventsCatalog')) set('eventsCatalog',[]);
  if(!localStorage.getItem('attendees')) set('attendees',[]);

  // demo numbers similar to admin analytics
  (function seedDemoIfEmptyPerEvent(){
    const cat = get('eventsCatalog','[]');
    const att = get('attendees','[]');
    const have = new Set(att.map(a=>a.event));
    const adminLike = {
      "Rock Concert":{issued:12,checked:8},
      "Food Festival":{issued:20,checked:17},
      "Hockey Game":{issued:9,checked:0},
      "Jazz Night":{issued:6,checked:5},
      "Winter Carnival":{issued:30,checked:22}
    };
    const now=Date.now();
    const add=[];
    for(const ev of cat){
      if(have.has(ev.title)) continue;
      const s=adminLike[ev.title]; if(!s) continue;
      const d=(ev.date||new Date().toISOString().slice(0,10));
      for(let i=0;i<s.issued;i++){
        const code=`TICKET-${String(i+1001).padStart(4,'0')}-${i%3?'PAID':'FREE'}`;
        const ts=now-(s.issued-i)*3600_000;
        const row={event:ev.title,code,status:'issued',tsIssued:ts,eventDate:d,capacity:ev.capacity??null};
        if(i<s.checked){row.status='checked_in';row.tsCheckedIn=ts+15*60_000;}
        add.push(row);
      }
    }
    if(add.length) set('attendees',att.concat(add));
  })();

  const evA=document.getElementById('evA'), dayA=document.getElementById('dayA');
  function eventsList(){
    const cat=get('eventsCatalog','[]');
    const att=get('attendees','[]');
    const map=new Map(cat.map(e=>[e.title,e]));
    att.forEach(a=>{ if(!map.has(a.event)) map.set(a.event,{title:a.event,date:a.eventDate||'',capacity:null}); });
    return [...map.values()].sort((a,b)=>a.title.localeCompare(b.title));
  }
  function buildSelect(){
    const opts=eventsList().map(e=>`<option value="${e.title}">${e.title}</option>`).join('');
    evA.innerHTML = `<option value="">— Select an event —</option>${opts}`;
  }
  buildSelect();

  const clearA=document.getElementById('clearA'), csvA=document.getElementById('csvA');
  const kIssued=document.getElementById('kIssued'), kIn=document.getElementById('kIn'), kRate=document.getElementById('kRate'), kLeft=document.getElementById('kLeft');
  const tbodyA=document.querySelector('#tblA tbody');

  function capOf(name){ const e=get('eventsCatalog','[]').find(x=>x.title===name); return e?.capacity??null }
  function fmt(t){ if(!t) return ''; const d=new Date(t); return d.toLocaleString() }

  function renderAnalytics(){
    const name=evA.value;
    if(!name){ tbodyA.innerHTML=''; kIssued.textContent='0'; kIn.textContent='0'; kRate.textContent='0%'; kLeft.textContent='—'; return }
    const all=get('attendees','[]').filter(a=>a.event===name);
    const f=dayA.value? all.filter(a=>(a.eventDate||'').startsWith(dayA.value)) : all;
    const issued=f.length, checked=f.filter(a=>a.status==='checked_in').length;
    const rate=issued? Math.round(100*checked/issued):0;
    const left=capOf(name)!=null? Math.max(capOf(name)-issued,0):'—';
    kIssued.textContent=issued; kIn.textContent=checked; kRate.textContent=rate+'%'; kLeft.textContent=left;
    tbodyA.innerHTML=f.map(a=>`
      <tr>
        <td style="font-family:ui-monospace,monospace">${a.code}</td>
        <td>${a.event}</td>
        <td>${a.status==='checked_in'
              ? '<span class="badge b-in">Checked-in</span>'
              : '<span class="badge b-issued">Issued</span>'}</td>
        <td>${fmt(a.tsIssued)}</td>
        <td>${fmt(a.tsCheckedIn)}</td>
      </tr>`).join('')||`<tr><td colspan="5" class="hint">No attendees.</td></tr>`;
  }

  evA.onchange=renderAnalytics; dayA.onchange=renderAnalytics; clearA.onclick=()=>{dayA.value=''; renderAnalytics()};
  csvA.onclick=()=>{
    const name=evA.value; if(!name) return alert('Pick an event first.');
    const rows=[['Event','Code','Status','Issued At','Checked In At','Event Date','Capacity']];
    const list=get('attendees','[]').filter(a=>a.event===name && (!dayA.value || (a.eventDate||'').startsWith(dayA.value)));
    list.forEach(a=>rows.push([a.event,a.code,a.status,fmt(a.tsIssued),fmt(a.tsCheckedIn),a.eventDate||'',capOf(a.event)??'']));
    const csv=rows.map(r=>r.map(v=>/[",\n]/.test(String(v))?`"${String(v).replace(/"/g,'""')}"`:String(v)).join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'}), url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=(name.replace(/\s+/g,'_'))+'_attendees.csv'; a.click(); URL.revokeObjectURL(url);
  };

  (function(){
    const p=new URLSearchParams(location.search); const ev=p.get('event');
    if(ev){ const id=setInterval(()=>{ if(evA.options.length){ evA.value=ev; clearInterval(id); renderAnalytics(); }},40); }
  })();
</script>
</body>
</html>