<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Organizer Dashboard – 404TicketsFound</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="css/homepage.css"/>
  <style>
    body{background:#f7f8fb}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #ddd;border-radius:10px;padding:10px 14px;background:#fff;cursor:pointer}
    .tab.active{background:#7a2b3d;color:#fff;border-color:#7a2b3d}
    .panel{margin-top:16px}
    .hidden{display:none}
    .bar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0 18px}
    select,input{padding:9px;border:1px solid #ddd;border-radius:10px;background:#fff}
    .btn{background:#7a2b3d;color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
    .k{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06);text-align:center}
    .k h4{margin:0;color:#7a2b3d;font-size:.95rem}
    .k p{margin:6px 0 0;font-size:1.4rem}
    .card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06)}
    .table{overflow:auto;max-height:420px;border:1px solid #eee;border-radius:10px;margin-top:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:left}
    .badge{padding:2px 8px;border-radius:999px;font-weight:600;font-size:12px}
    .b-issued{background:#eef;color:#1b3a8a}
    .b-in{background:#def7e0;color:#236b2a}
    iframe{width:100%;border:0;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06);background:#fff}
    .btn.danger{background:#b3261e}
    .btn.danger:hover{background:#8f1f18}
  </style>
</head>
<body>
<script>
  const auth = JSON.parse(localStorage.getItem('auth')||'null');
  if(!auth || auth.role!=='organizer') location.href='404NotFoundLogin.html?reason=organizer_only';
</script>

<header>
  <div class="container header-content">
    <h1 class="logo">404TicketsFound</h1>
    <nav>
      <a href="index.html">Home</a>
      <a href="SearchResults.html">Search</a>
      <a href="CreateEvent.html">Create Event</a>
      <a href="organizer.html" class="active">Organizer Dashboard</a>
      <span id="authSlot"></span> 
    </nav>
  </div>
</header>
<script src="nav.js"></script>

<div class="wrap">
  <h2>Organizer Dashboard</h2>

  <div class="tabs">
    <button class="tab active" data-tab="analytics">Event Analytics</button>
    <button class="tab" data-tab="checker">Ticket Validity</button>
  </div>

  <!-- ANALYTICS -->
  <section id="analytics" class="panel">
    <div class="bar">
      <label>Event
        <select id="evA"></select>
      </label>
      <label>Date
        <input type="date" id="dayA"/>
      </label>
      <button class="btn" id="clearA">Clear</button>
      <button class="btn" id="csvA">Export Attendees (CSV)</button>
      <button class="btn danger" id="delA">Delete Event</button>
    </div>

    <div class="kpis">
      <div class="k"><h4>Tickets Issued</h4><p id="kIssued">0</p></div>
      <div class="k"><h4>Checked In</h4><p id="kIn">0</p></div>
      <div class="k"><h4>Attendance Rate</h4><p id="kRate">0%</p></div>
      <div class="k"><h4>Remaining Capacity</h4><p id="kLeft">—</p></div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px">Attendees</h3>
      <div class="table">
        <table id="tblA">
          <thead>
            <tr>
              <th>Code</th><th>Event</th><th>Status</th><th>Issued</th><th>Checked In</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- CHECKER (embed TicketValidity) -->
  <section id="checker" class="panel hidden">
    <div class="bar" style="justify-content:space-between;align-items:center">
      <div><strong>Ticket Validity</strong> (embedded)</div>
      <a class="btn" href="TicketValidity.html" target="_blank">Open Full Page</a>
    </div>
    <iframe id="checkerFrame" src="TicketValidity.html" title="Ticket Validity"></iframe>
  </section>
</div>

<footer>
  <p style="text-align:center;margin:28px 0;color:#777">&copy; 2025 404TicketsFound</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // Tabs handling
  document.querySelector('.tabs').addEventListener('click', e=>{
    if(!e.target.matches('.tab')) return;
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    e.target.classList.add('active');
    const id = e.target.dataset.tab;
    document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
    if(id==='analytics') renderAnalytics();
    if(id==='checker') resizeFrame();
  });

  const frame = document.getElementById('checkerFrame');
  function resizeFrame(){
    try{
      const h = frame.contentDocument?.body?.scrollHeight || 900;
      frame.style.height = Math.max(h, 900)+'px';
    }catch(_){
      frame.style.height='900px';
    }
  }
  frame.addEventListener('load', resizeFrame);

  // Local helpers
  const get = (k, f='[]') => JSON.parse(localStorage.getItem(k) || f);
  const set = (k, v) => localStorage.setItem(k, JSON.stringify(v));

  // Make sure these keys exist
  if(!localStorage.getItem('eventsCatalog')) set('eventsCatalog', []);
  if(!localStorage.getItem('attendees')) set('attendees', []);

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
    authDomain: "found-5ecc0.firebaseapp.com",
    projectId: "found-5ecc0",
    storageBucket: "found-5ecc0.appspot.com",
    messagingSenderId: "160156481057",
    appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Load events from Firestore into localStorage "eventsCatalog"
  async function syncEventsFromFirestore(){
    try {
      const snap = await getDocs(collection(db, "events"));
      const list = snap.docs.map(d => {
        const data = d.data();
        return {
          title: data.description || data.title || "Untitled Event",
          date: data.date || "",
          capacity: data.capacity ?? null
        };
      });
      set('eventsCatalog', list);
    } catch (e) {
      console.error("Failed to load events from Firestore for organizer dashboard:", e);
    }
  }

  const evA   = document.getElementById('evA');
  const dayA  = document.getElementById('dayA');
  const clearA= document.getElementById('clearA');
  const csvA  = document.getElementById('csvA');

  const kIssued = document.getElementById('kIssued');
  const kIn     = document.getElementById('kIn');
  const kRate   = document.getElementById('kRate');
  const kLeft   = document.getElementById('kLeft');
  const tbodyA  = document.querySelector('#tblA tbody');

  function capOf(name){
    const e = get('eventsCatalog','[]').find(x=>x.title===name);
    return e?.capacity ?? null;
  }
  function fmt(t){
    if(!t) return '';
    const d = new Date(t);
    return d.toLocaleString();
  }

  function eventsList(){
    const cat = get('eventsCatalog','[]');
    const att = get('attendees','[]');
    const map = new Map(cat.map(e => [e.title, e]));
    att.forEach(a => {
      if(!map.has(a.event)){
        map.set(a.event, { title:a.event, date:a.eventDate||'', capacity:null });
      }
    });
    return [...map.values()].sort((a,b)=>a.title.localeCompare(b.title));
  }

  function buildSelect(){
    const opts = eventsList().map(e => `<option value="${e.title}">${e.title}</option>`).join('');
    evA.innerHTML = `<option value="">— Select an event —</option>${opts}`;
  }

  function deleteEventByName(name){
    const cat = get('eventsCatalog','[]').filter(e => e.title !== name);
    const att = get('attendees','[]').filter(a => a.event !== name);
    set('eventsCatalog', cat);
    set('attendees', att);
  }

  document.getElementById('delA').onclick = ()=>{
    const name = evA.value;
    if(!name) {
      alert('Pick an event first.');
      return;
    }
    if(!confirm(`Delete "${name}" and all its attendees in this dashboard?`)) return;
    deleteEventByName(name);
    buildSelect();
    evA.value = '';
    dayA.value = '';
    kIssued.textContent='0';
    kIn.textContent='0';
    kRate.textContent='0%';
    kLeft.textContent='—';
    tbodyA.innerHTML = `<tr><td colspan="5" class="hint">No attendees.</td></tr>`;
    alert('Event removed from local dashboard data.');
  };

  function renderAnalytics(){
    const name = evA.value;
    if(!name){
      tbodyA.innerHTML = `<tr><td colspan="5" class="hint">No event selected.</td></tr>`;
      kIssued.textContent='0';
      kIn.textContent='0';
      kRate.textContent='0%';
      kLeft.textContent='—';
      return;
    }

    const all = get('attendees','[]').filter(a => a.event === name);
    const filtered = dayA.value
      ? all.filter(a => (a.eventDate || '').startsWith(dayA.value))
      : all;

    const issued = filtered.length;
    const checked = filtered.filter(a => a.status === 'checked_in').length;
    const rate = issued ? Math.round(100 * checked / issued) : 0;
    const left = capOf(name) != null ? Math.max(capOf(name) - issued, 0) : '—';

    kIssued.textContent = issued;
    kIn.textContent     = checked;
    kRate.textContent   = rate + '%';
    kLeft.textContent   = left;

    tbodyA.innerHTML = filtered.map(a => `
      <tr>
        <td style="font-family:ui-monospace,monospace">${a.code}</td>
        <td>${a.event}</td>
        <td>${
          a.status === 'checked_in'
            ? '<span class="badge b-in">Checked-in</span>'
            : '<span class="badge b-issued">Issued</span>'
        }</td>
        <td>${fmt(a.tsIssued)}</td>
        <td>${fmt(a.tsCheckedIn)}</td>
      </tr>
    `).join('') || `<tr><td colspan="5" class="hint">No attendees.</td></tr>`;
  }

  evA.onchange   = renderAnalytics;
  dayA.onchange  = renderAnalytics;
  clearA.onclick = () => { dayA.value=''; renderAnalytics(); };

  csvA.onclick = () => {
    const name = evA.value;
    if(!name){
      alert('Pick an event first.');
      return;
    }
    const rows = [['Event','Code','Status','Issued At','Checked In At','Event Date','Capacity']];
    const list = get('attendees','[]').filter(a =>
      a.event === name && (!dayA.value || (a.eventDate || '').startsWith(dayA.value))
    );
    list.forEach(a => {
      rows.push([
        a.event,
        a.code,
        a.status,
        fmt(a.tsIssued),
        fmt(a.tsCheckedIn),
        a.eventDate || '',
        capOf(a.event) ?? ''
      ]);
    });

    const csv = rows.map(r =>
      r.map(v => /[",\n]/.test(String(v))
        ? `"${String(v).replace(/"/g,'""')}"`
        : String(v)
      ).join(',')
    ).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = (name.replace(/\s+/g,'_')) + '_attendees.csv';
    a.click();
    URL.revokeObjectURL(url);
  };

  (async function initOrganizer(){
    await syncEventsFromFirestore();
    buildSelect();

    const p = new URLSearchParams(location.search);
    const ev = p.get('event');
    if(ev){
      const id = setInterval(() => {
        if(evA.options.length){
          evA.value = ev;
          clearInterval(id);
          renderAnalytics();
        }
      }, 40);
    }
  })();
</script>
</body>
</html>