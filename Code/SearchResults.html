<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Results â€” 404TicketsFound</title>
    <link rel="stylesheet" href="css/homepage.css">
    <script src="JS/nav.js" defer></script>
</head>
<body>
    <header>
        <div class="container header-content">
          <h1 class="logo"><a href="index.html">404TicketsFound</a></h1>
          <nav>
            <a href="index.html">Home</a>
            <a href="SearchResults.html" class="active">Search</a>
            <span id="authSlot"></span>
          </nav>
        </div>
      </header>
      <script src="nav.js"></script>

<section class="section container">
    <h2 class="section-title">Filter Events</h2>
    <form id="filter-form" class="form" style="gap:8px;display:flex;flex-wrap:wrap;align-items:center;">
        <input type="text" id="location" placeholder="Location">
        <input type="text" id="organization" placeholder="Organization">
        <input type="number" id="minPrice" placeholder="Min Price">
        <input type="number" id="maxPrice" placeholder="Max Price">
        <select id="type">
            <option value="">All Types</option>
            <option value="Concert">Concert</option>
            <option value="Festival">Festival</option>
            <option value="Sports">Sports</option>
        </select>
        <div style="display:flex;align-items:center;gap:8px;">
            <input type="date" id="eventDate" disabled>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
                <input type="checkbox" id="allDates" checked>
                All dates
            </label>
        </div>
        <button type="submit" class="btn-primary">Filter</button>
    </form>
</section>

<section id="events" class="section container">
    <h2 id="results-title" class="section-title">All Events</h2>
    <div id="results" class="grid"></div>
</section>

<footer>
    <p>&copy; 2025 404TicketsFound. All rights reserved.</p>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
    authDomain: "found-5ecc0.firebaseapp.com",
    projectId: "found-5ecc0",
    storageBucket: "found-5ecc0.appspot.com",
    messagingSenderId: "160156481057",
    appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const resultsDiv = document.getElementById("results");
const resultsTitle = document.getElementById("results-title");
const form = document.getElementById("filter-form");
const eventDateEl = document.getElementById("eventDate");
const allDatesEl = document.getElementById("allDates");

let events = [];

// Helper to format date
const fmtYMD = s => {
    if (!s) return '';
    const [y,m,d]=s.split('-').map(Number);
    const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    return `${months[(m||1)-1]} ${String(d).padStart(2,'0')}, ${y}`;
};

// Load events from Firestore
async function loadEvents() {
    const eventsCol = collection(db, "events"); // lowercase collection
    const snapshot = await getDocs(eventsCol);
    events = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
            id: doc.id,
            name: data.description || 'Unnamed Event', // <-- use description
            location: data.location || 'TBA',
            organization: data.organization || 'Organizer',
            type: data.type || 'Event',
            date: data.date || '',
            start: data.start || (data.date ? `${data.date}T18:00:00` : ''),
            end: data.end || (data.date ? `${data.date}T21:00:00` : ''),
            price: Number(data.price) || 0
        };
    });
    displayEvents(events);
}

// Render events
function cardHTML(ev) {
    const priceText = ev.price === 0 ? 'Free' : `$${ev.price}`;
    return `
        <div class="card">
            <h4>${ev.name}</h4>
            <p>ğŸ“ ${ev.location}</p>
            <p>ğŸ¢ ${ev.organization}</p>
            <p>ğŸ“… ${fmtYMD(ev.date)}</p>
            <p>ğŸ’µ ${priceText}</p>
            <p>ğŸŸï¸ ${ev.type}</p>
            <button class="btn-primary buy-btn" data-name="${ev.name}">${ev.price===0?'Claim Free Ticket':'Buy Ticket'}</button>
            <a class="btn-secondary" href="view-event.html?event=${encodeURIComponent(ev.name)}">View Event</a>
        </div>`;
}

function displayEvents(list){
    if(list.length === 0){
        resultsDiv.innerHTML = '<p>No events found.</p>';
    } else {
        resultsDiv.innerHTML = list.map(cardHTML).join('');
    }
}

// Filter events
form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const location = document.getElementById("location").value.toLowerCase();
    const organization = document.getElementById("organization").value.toLowerCase();
    const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;
    const type = document.getElementById("type").value;
    const allDates = allDatesEl.checked;
    const eventDate = eventDateEl.value;

    const filtered = events.filter(ev=>{
        const price = ev.price || 0;
        const matchesLocation = ev.location.toLowerCase().includes(location);
        const matchesOrg = ev.organization.toLowerCase().includes(organization);
        const matchesPrice = price >= minPrice && price <= maxPrice;
        const matchesType = type === "" || ev.type === type;
        const matchesDate = allDates || eventDate === "" || ev.date === eventDate;
        return matchesLocation && matchesOrg && matchesPrice && matchesType && matchesDate;
    });

    resultsTitle.textContent = "Your Search Results";
    displayEvents(filtered);
});

// Buy or claim ticket
resultsDiv.addEventListener("click", e=>{
    const btn = e.target.closest(".buy-btn");
    if(!btn) return;
    const name = btn.dataset.name;
    const ev = events.find(x => x.name === name);
    if(!ev) return;

    const ticketID = Date.now().toString(36) + Math.random().toString(36).substring(2,8);
    localStorage.setItem('selectedTicket', JSON.stringify({
        event: ev.name,
        id: ticketID,
        price: ev.price,
        type: ev.price===0?'FREE':'PAID'
    }));

    if(ev.price===0){
        alert(`You have claimed a free ticket for "${ev.name}"!`);
        location.href = `ticket-confirmation.html?event=${encodeURIComponent(ev.name)}&id=${ticketID}&type=FREE`;
    } else {
        location.href = `payment.html?event=${encodeURIComponent(ev.name)}&id=${ticketID}&price=${ev.price}&type=PAID`;
    }
});

// Enable/disable date input
allDatesEl.addEventListener("change", ()=>{
    const useAll = allDatesEl.checked;
    eventDateEl.disabled = useAll;
    if(useAll) eventDateEl.value = "";
});

// Initial load
loadEvents();
</script>
</body>
</html>
