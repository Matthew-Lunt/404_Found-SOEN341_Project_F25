<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Create Event â€“ 404TicketsFound</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="css/homepage.css"/>
  <style>
    body{background:#f7f8fb}
    .wrap{max-width:960px;margin:24px auto;padding:0 16px}
    .grid2{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){.grid2{grid-template-columns:1fr}}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 14px rgba(20,20,20,.06)}
    form{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .full{grid-column:1/-1}
    input,select,textarea{padding:10px;border:1px solid #ddd;border-radius:10px;font:inherit}
    .row{display:flex;gap:12px;align-items:center}
    .btn{background:#7a2b3d;color:#fff;border:0;padding:10px 16px;border-radius:10px;cursor:pointer}
    .hint{color:#666;font-size:.9rem}
  </style>
</head>
<body>

<!-- Auth check -->
<script>
  const authData = JSON.parse(localStorage.getItem('auth')||'null');
  if(!authData || authData.role!=='organizer') {
    location.href='404NotFoundLogin.html?reason=organizer_only';
  }
</script>

<header>
  <div class="container header-content">
    <h1 class="logo">404TicketsFound</h1>
    <nav>
      <a href="index.html#events">Home</a>
      <a href="SearchResults.html">Search</a>
      <a class="active" href="CreateEvent.html">Create Event</a>
      <a href="organizer.html">Organizer Dashboard</a>
    </nav>
  </div>
</header>

<script src="nav.js"></script>

<div class="wrap">
  <h2>Create Event</h2>

  <div class="grid2">
    <!-- Event Form -->
    <div class="card">
      <form id="createForm" novalidate>
        <input id="title" class="full" type="text" placeholder="Event title" required/>
        <input id="location" class="full" type="text" placeholder="Location (City, ST)" required/>
        <input id="organization" class="full" type="text" placeholder="Organization" value="Organizer"/>
        <select id="type">
          <option>Concert</option><option>Festival</option><option>Sports</option><option>Other</option>
        </select>
        <input id="price" type="number" min="0" step="1" placeholder="Price (0=Free)" value="0"/>
        <input id="capacity" type="number" min="0" step="1" placeholder="Capacity" value="0"/>
        <input id="date" type="date" required/>
        <input id="start" type="time" value="18:00"/>
        <input id="end" type="time" value="21:00"/>
        <textarea id="desc" class="full" rows="3" placeholder="Description (optional)"></textarea>
        <div class="row full" style="justify-content:flex-end">
          <button id="publishBtn" class="btn" type="button">Publish Event</button>
        </div>
        <p class="hint full">After publishing, youâ€™ll be redirected to Search with this event highlighted.</p>
      </form>
    </div>

    <!-- Event Preview -->
    <div class="card" id="preview">
      <h3 style="margin:0 0 8px">Preview</h3>
      <div class="p-title" style="font-weight:700;font-size:1.1rem">Event title</div>
      <div class="p-meta" style="color:#555;margin:6px 0">
        <div id="pLoc">ğŸ“ â€”</div>
        <div id="pOrg">ğŸ¢ â€”</div>
        <div id="pDate">ğŸ“… â€”</div>
        <div id="pType">ğŸŸï¸ â€”</div>
        <div id="pCap">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Capacity: â€”</div>
      </div>
      <div id="pPrice" style="margin:8px 0;font-weight:700">â€”</div>
      <button class="btn" type="button" disabled>Buy / Claim (preview)</button>
    </div>
  </div>
</div>

<footer><p style="text-align:center;margin:28px 0;color:#777">&copy; 2025 404TicketsFound</p></footer>

<!-- Firebase + Publish Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
    authDomain: "found-5ecc0.firebaseapp.com",
    projectId: "found-5ecc0",
    storageBucket: "found-5ecc0.appspot.com",
    messagingSenderId: "160156481057",
    appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // Helper functions
  function toISO(date, time){ return `${date}T${(time||'18:00')}`; }
  function money(n){ n=Number(n||0); return n===0?'Free':`$${n}`; }
  function fmtRange(date,start,end){
    if(!date) return 'â€”';
    const a=new Date(`${date}T${start||'18:00'}`), b=new Date(`${date}T${end||'21:00'}`);
    const f=o=>o.toLocaleString(undefined,{year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
    return `${f(a)} â†’ ${f(b)}`;
  }

  // Update live preview
  function updatePreview(){
    const f=document.getElementById('createForm');
    document.querySelector('#preview .p-title').textContent=f.title.value.trim()||'Event title';
    document.getElementById('pLoc').textContent=`ğŸ“ ${f.location.value.trim()||'â€”'}`;
    document.getElementById('pOrg').textContent=`ğŸ¢ ${f.organization.value.trim()||'â€”'}`;
    document.getElementById('pDate').textContent=`ğŸ“… ${fmtRange(f.date.value,f.start.value,f.end.value)}`;
    document.getElementById('pType').textContent=`ğŸŸï¸ ${f.type.value||'Other'}`;
    document.getElementById('pCap').textContent=`ğŸ§‘â€ğŸ¤â€ğŸ§‘ Capacity: ${f.capacity.value||'â€”'}`;
    document.getElementById('pPrice').textContent=money(f.price.value);
  }

  // Publish event to Firebase
  async function publishEvent(){
    const f=document.getElementById('createForm');
    const title=f.title.value.trim();
    const location=f.location.value.trim();
    const organization=f.organization.value.trim() || 'Organizer';
    const type=f.type.value || 'Other';
    const price=Number(f.price.value||0);
    const capacity=Number(f.capacity.value||0);
    const date=f.date.value;
    const start=f.start.value||'18:00';
    const end=f.end.value||'21:00';
    const desc=f.desc.value || '';

    if(!title||!location||!date){ alert('Title, location, and date are required.'); return; }

    try {
      const docRef = await addDoc(collection(db, "events"), {
        title,
        description: desc || title,  // description field used
        location,
        organization,
        type,
        price,
        capacity,
        date,
        start: `${date}T${start}`,
        end: `${date}T${end}`,
        createdBy: auth.currentUser ? auth.currentUser.uid : null,
        timestamp: Date.now()
      });

      alert(`Event published successfully!`);
      location.href=`SearchResults.html?event=${encodeURIComponent(title)}`;
    } catch(e) {
      console.error("Error publishing event:", e);
      alert('Failed to publish event.');
    }
  }

  document.getElementById('publishBtn').addEventListener('click', publishEvent);
  document.addEventListener('input', e=>{ if(e.target.closest('#createForm')) updatePreview() });
  document.addEventListener('DOMContentLoaded', updatePreview);
</script>
</body>
</html>
