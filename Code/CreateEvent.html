<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Event</title>
  <link rel="stylesheet" href="css/homepage.css">
</head>

<body>
  <script>
    (function () {
      try {
        const a = JSON.parse(localStorage.getItem('auth') || 'null');
        if (!a || a.role !== 'organizer') {
          // not an organizer ‚Üí send to login
          location.href = '404NotFoundLogin.html?reason=organizer_only';
        }
      } catch (e) {
        location.href = '404NotFoundLogin.html?reason=organizer_only';
      }
    })();
  </script>
  <header>
    <div class="container header-content">
      <h1 class="logo">404TicketsFound</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="SearchResults.html">Search</a>
        <a href="CreateEvent.html" class="active">Create Event</a>
        <a href="organizer.html">Organizer Dashboard</a>
      </nav>
    </div>
  </header>
  <script>
    (function(){
      const nav = document.querySelector('header nav');
      if(!nav) return;
    
      const auth = JSON.parse(localStorage.getItem('auth')||'null');
      // remove existing Login button if present
      const loginLink = [...nav.querySelectorAll('a')].find(a=>/404NotFoundLogin\.html/.test(a.getAttribute('href')||''));
      if (auth && loginLink) loginLink.remove();
    
      // keeps Home/Search always visible; no redirects
      const wrap = document.createElement('span');
      wrap.style.marginLeft = '10px';
      wrap.innerHTML = auth
        ? `<span style="padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:.9rem;">
             ${auth.role.toUpperCase()}
           </span>
           <button id="logoutBtn" class="btn-secondary" style="margin-left:8px;">Logout</button>`
        : `<a href="404NotFoundLogin.html" class="btn-secondary">Login</a>`;
    
      nav.appendChild(wrap);
    
      nav.addEventListener('click', (e)=>{
        if(e.target && e.target.id==='logoutBtn'){
          e.preventDefault();
          localStorage.removeItem('auth'); // **does not** block Home/Search
          alert('Logged out.');
          location.reload();
        }
      });
    })();
    </script>
  <section class="section container">
    <h2 class="section-title">Create an Event</h2>

    <form id="create-event-form" class="form">
      <input type="text" id="title" placeholder="Event Title" required>
      <input type="text" id="organizer" placeholder="Organizer Name" required>
      <textarea id="description" rows="3" placeholder="Event Description" required></textarea>

      <label for="date">Date:</label>
      <input type="date" id="date" required>

      <label for="timeStart">Start Time:</label>
      <input type="time" id="timeStart" required>

      <label for="timeEnd">End Time (optional):</label>
      <input type="time" id="timeEnd" placeholder="Leave blank for 'Late'">

      <input type="text" id="location" placeholder="Location" required>
      <input type="number" id="capacity" placeholder="Ticket Capacity" min="1" required>

      <label>Ticket Type:</label>
      <div>
        <input type="radio" id="free" name="ticketType" value="Free" checked>
        <label for="free">Free</label>
        <input type="radio" id="paid" name="ticketType" value="Paid">
        <label for="paid">Paid</label>
      </div>

      <div id="priceField" style="display: none;">
        <input type="number" id="price" placeholder="Ticket Price ($)" min="0">
      </div>

      <button type="submit" class="btn-primary">Preview Event</button>
    </form>
  </section>

  <section id="preview" class="section container" style="display: none;">
    <h2 class="section-title">Event Preview</h2>
    <div id="preview-content" class="card"></div>
    <button id="publish-btn" class="btn-primary">Publish Event</button>
  </section>

  <footer>
    <p>&copy; 2025 404TicketsFound. All rights reserved.</p>
  </footer>

  <script>
     // show create and publish only for organizer
    (function(){
      try {
        const a = JSON.parse(localStorage.getItem('auth') || 'null');
        if (!a || a.role !== 'organizer') {
          location.href = '404NotFoundLogin.html';
        }
      } catch (e) {
        location.href = '404NotFoundLogin.html';
      }
    })();

    const form = document.getElementById('create-event-form');
    const priceField = document.getElementById('priceField');
    const preview = document.getElementById('preview');
    const previewContent = document.getElementById('preview-content');
    const priceInput = document.getElementById('price');
    const publishBtn = document.getElementById('publish-btn');
    const dateInput = document.getElementById('date');

    const today = new Date().toISOString().split("T")[0];
    dateInput.setAttribute("min", today);

    document.getElementById("paid").addEventListener("change", () => {
      priceField.style.display = "block";
      priceInput.required = true;
    });
    document.getElementById("free").addEventListener("change", () => {
      priceField.style.display = "none";
      priceInput.required = false;
      priceInput.value = "";
    });

    let __lastEventForPublish = null;

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const startTime = document.getElementById("timeStart").value;
      const endTime = document.getElementById("timeEnd").value;
      const timeDisplay = endTime ? `${startTime} ‚Äì ${endTime}` : `${startTime} ‚Äì Late`;

      const eventData = {
        title: document.getElementById('title').value,
        organizer: document.getElementById('organizer').value,
        description: document.getElementById('description').value,
        date: document.getElementById('date').value,
        time: timeDisplay,
        location: document.getElementById('location').value,
        capacity: document.getElementById('capacity').value,
        ticketType: document.querySelector('input[name="ticketType"]:checked').value,
        price: priceInput.value || 'Free'
      };

      __lastEventForPublish = eventData;

      previewContent.innerHTML = `
        <h4>${eventData.title}</h4>
        <p><strong>Organizer:</strong> ${eventData.organizer}</p>
        <p>${eventData.description}</p>
        <p>üìÖ ${eventData.date} at ${eventData.time}</p>
        <p>üìç ${eventData.location}</p>
        <p>üéüÔ∏è Capacity: ${eventData.capacity}</p>
        <p>üíµ ${eventData.ticketType === 'Paid' ? '$' + eventData.price : 'Free'}</p>
      `;

      preview.style.display = "block";
      preview.scrollIntoView({ behavior: "smooth" });
    });

    // Publish event to backend
    publishBtn.addEventListener('click', async () => {
      if (!__lastEventForPublish) {
        alert("Please preview the event first.");
        return;
      }

      try {
        const response = await fetch("http://localhost:5000/api/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(__lastEventForPublish)
        });

        const data = await response.json();

        if (response.ok) {
          alert("‚úÖ Event published successfully!");
          localStorage.setItem('highlightDate', __lastEventForPublish.date);
          window.location.href = "SearchResults.html";
        } else {
          alert("‚ùå Failed to publish event: " + data.error);
        }
      } catch (error) {
        alert("‚ö†Ô∏è Could not reach the server. Make sure Node.js is running!");
        console.error("Error:", error);
      }
    });
  </script>
</body>
</html>
