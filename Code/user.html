<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile</title>
    <link rel="stylesheet" href="css/homepage.css">
    <style>
        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.2rem;
        }

        .card {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background-color: #912338;
            border: none;
            padding: 0.6rem 1.2rem;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary:hover {
            background-color: #a23445;
        }

        .btn-secondary {
            background-color: #6c757d;
            border: none;
            padding: 0.6rem 1.2rem;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-left: 0.5rem;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .calendar-container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            text-align: center;
            margin-bottom: 1rem;
        }

        .calendar-header h3 {
            margin: 0;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day-name {
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 10px 0;
            border-radius: 6px;
        }

        .calendar-day {
            height: 80px;
            padding: 8px;
            background-color: #fafafa;
            border-radius: 6px;
            border: 1px solid #ddd;
            cursor: default;
        }

        .calendar-day:hover {
            background-color: #e7f0ff;
        }

        .empty-day {
            background-color: transparent;
            border: none;
            cursor: default;
        }

        /* Edit Profile Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }

        /* Friends List */
        .friends-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .friend-card {
            background: #fff;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .friend-card h4 {
            margin: 0 0 0.5rem 0;
            color: #912338;
        }

        .friend-card p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }

        .friend-card button {
            margin-top: 0.5rem;
            padding: 0.4rem 0.8rem;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .friend-card button:hover {
            background-color: #c82333;
        }

        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
    <script src="JS/nav.js" defer></script>
</head>

<body>
    <header>
        <div class="container header-content">
            <h1 class="logo"><a href="index.html">404TicketsFound </a></h1>
            <nav id="nav-container">
                <a href="SearchResults.html">Search</a>
                <a href="AddFriend.html"> Add Friend </a>
            </nav>
        </div>
    </header>

    <script>
        (function () {
            const nav = document.getElementById('nav-container');
            if (!nav) return;

            nav.querySelectorAll('.auth-ui').forEach(el => el.remove());
            const auth = JSON.parse(localStorage.getItem('auth') || 'null');
            const span = document.createElement('span');
            span.className = 'auth-ui';
            span.style.marginLeft = '12px';

            if (auth) {
                let extraLink = '';
                if (auth.role === 'organizer') {
                    extraLink = `<a href="organizer.html" class="btn-secondary" style="margin-left:8px;">Dashboard</a>`;
                } else if (auth.role === 'user') {
                    extraLink = `<a href="user.html" class="btn-secondary" style="margin-left:8px;">My Profile</a>`;
                }

                span.innerHTML = `
      <span style="padding:6px 10px;border:1px solid #ddd;border-radius:999px;font-size:.9rem;">
        ${auth.role?.toUpperCase() || 'USER'}
      </span>
      ${extraLink}
      <button id="logoutBtn" class="btn-secondary" style="margin-left:8px;">Logout</button>`;
            } else {
                span.innerHTML = `<a href="404NotFoundLogin.html" class="btn-secondary">Login</a>`;
            }

            nav.appendChild(span);

            nav.addEventListener('click', e => {
                if (e.target.id === 'logoutBtn') {
                    e.preventDefault();
                    localStorage.removeItem('auth');
                    alert('Logged out.');
                    location.href = 'index.html';
                }
            });
        })();
    </script>

    <section class="section container">
        <h2 class="section-title">My Profile</h2>
        <div class="card">
            <h3 id="user-name"></h3>
            <p id="user-email"></p>
            <button class="btn-primary" id="edit-profile-btn">Edit Profile</button>
        </div>
    </section>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <span class="close">&times;</span>
            </div>
            <form id="edit-profile-form">
                <div class="form-group">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name" required>
                </div>
                <div class="form-group">
                    <label for="edit-email">Email</label>
                    <input type="email" id="edit-email" required>
                </div>
                <button type="submit" class="btn-primary">Save Changes</button>
                <button type="button" class="btn-secondary" id="cancel-edit">Cancel</button>
            </form>
        </div>
    </div>

    <section class="section container">
        <h2 class="section-title">My Friends</h2>
        <div id="friends-list" class="friends-grid"></div>
    </section>

    <section class="section container">
        <h2 class="section-title">Upcoming Events</h2>

        <div class="calendar-container">
            <div class="calendar-header">
                <button id="prevMonth" class="btn-primary">←</button>
                <h3 id="monthYear"></h3>
                <button id="nextMonth" class="btn-primary">→</button>
            </div>
            <div class="calendar-grid" id="calendar"></div>
        </div>
    </section>

    <section class="section container">
        <h2 class="section-title">Past Events</h2>
        <div id="past-events" class="events-grid"></div>
    </section>

    <footer>
        <p>&copy; 2025 404TicketsFound. All rights reserved.</p>
    </footer>

    <script>
        // --- Calendar Functionality ---
        const calendar = document.getElementById('calendar');
        const monthYear = document.getElementById('monthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        let currentDate = new Date();

        function renderCalendar(date) {
            calendar.innerHTML = '';

            const year = date.getFullYear();
            const month = date.getMonth();

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            monthYear.textContent = `${monthNames[month]} ${year}`;

            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            dayNames.forEach(day => {
                const div = document.createElement('div');
                div.classList.add('calendar-day-name');
                div.textContent = day;
                calendar.appendChild(div);
            });

            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement('div');
                empty.classList.add('calendar-day', 'empty-day');
                calendar.appendChild(empty);
            }

            for (let day = 1; day <= lastDate; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.textContent = day;
                calendar.appendChild(dayDiv);
            }
        }

        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });

        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        renderCalendar(currentDate);
    </script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
            authDomain: "found-5ecc0.firebaseapp.com",
            projectId: "found-5ecc0",
            storageBucket: "found-5ecc0.appspot.com",
            messagingSenderId: "160156481057",
            appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const nameEl = document.getElementById('user-name');
        const emailEl = document.getElementById('user-email');

        // Modal elements
        const modal = document.getElementById('edit-profile-modal');
        const editBtn = document.getElementById('edit-profile-btn');
        const closeBtn = document.querySelector('.close');
        const cancelBtn = document.getElementById('cancel-edit');
        const editForm = document.getElementById('edit-profile-form');
        const editNameInput = document.getElementById('edit-name');
        const editEmailInput = document.getElementById('edit-email');

        let currentUser = null;
        let currentCollection = 'Users';
        let refreshInterval = null;

        // Function to load user profile
        async function loadUserProfile(uid) {
            const storedAuth = JSON.parse(localStorage.getItem('auth') || '{}');
            const role = storedAuth.role || 'user';
            currentCollection = role === 'organizer' ? 'Organizers' : 'Users';

            try {
                const snap = await getDoc(doc(db, currentCollection, uid));
                if (snap.exists()) {
                    const data = snap.data();
                    nameEl.textContent = data.name || 'No name set';
                    emailEl.textContent = data.email || 'No email set';

                    // Load friends list
                    await loadFriendsList(currentUser.uid);
                } else {
                    nameEl.textContent = 'Profile not found';
                    emailEl.textContent = '';
                    console.warn('No document found for UID:', uid);
                }
            } catch (err) {
                console.error('Error loading profile:', err);
                nameEl.textContent = 'Error loading profile';
                emailEl.textContent = '';
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserProfile(user.uid);

                // Set up auto-refresh every 3 seconds
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(async () => {
                    if (currentUser) {
                        try {
                            const snap = await getDoc(doc(db, currentCollection, currentUser.uid));
                            if (snap.exists()) {
                                const data = snap.data();
                                await loadFriendsList(currentUser.uid);

                            }
                        } catch (err) {
                            console.error('Error refreshing friends:', err);
                        }
                    }
                }, 3000);

            } else {
                alert('You must be logged in to view your profile.');
                window.location.href = '404NotFoundLogin.html';
            }
        });

        // Modal open
        editBtn.addEventListener('click', async () => {
            if (!currentUser) return;

            try {
                const snap = await getDoc(doc(db, currentCollection, currentUser.uid));
                if (snap.exists()) {
                    const data = snap.data();
                    editNameInput.value = data.name || '';
                    editEmailInput.value = data.email || '';
                    modal.style.display = 'block';
                }
            } catch (err) {
                console.error('Error loading profile for edit:', err);
                alert('Error loading profile data');
            }
        });

        // Modal close
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        cancelBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Form submit
        editForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) return;

            const newName = editNameInput.value.trim();
            const newEmail = editEmailInput.value.trim();

            try {
                await updateDoc(doc(db, currentCollection, currentUser.uid), {
                    name: newName,
                    email: newEmail
                });

                nameEl.textContent = newName;
                emailEl.textContent = newEmail;
                modal.style.display = 'none';
                alert('Profile updated successfully!');
            } catch (err) {
                console.error('Error updating profile:', err);
                alert('Error updating profile. Please try again.');
            }
        });

        // Load friends list
        async function loadFriendsList(uid) {
            const friendsList = document.getElementById('friends-list');
            const userRef = doc(db, 'Users', uid);
            const userSnap = await getDoc(userRef);

            if (!userSnap.exists()) {
                friendsList.innerHTML = '<p class="empty-state">Error loading friends.</p>';
                return;
            }

            const friendsIds = userSnap.data().friends || [];

            if (friendsIds.length === 0) {
                friendsList.innerHTML = '<p class="empty-state">You have no friends yet. Go add some!</p>';
                return;
            }

            const friendsData = [];

            // Fetch friend info
            for (const fid of friendsIds) {
                try {
                    const friendSnap = await getDoc(doc(db, 'Users', fid));
                    if (friendSnap.exists()) {
                        friendsData.push({ id: fid, ...friendSnap.data() });
                    }
                } catch (err) {
                    console.error('Error fetching friend:', fid, err);
                }
            }

            // Render friends
            friendsList.innerHTML = '';
            friendsData.forEach(friend => {
                const div = document.createElement('div');
                div.className = 'friend-card';
                div.innerHTML = `
            <h4>${friend.name}</h4>
            <p>${friend.email || ''}</p>
            <button class="unfollow-btn" data-id="${friend.id}">Unfollow</button>
        `;
                friendsList.appendChild(div);
            });

            // Unfollow buttons
            document.querySelectorAll('.unfollow-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const fid = e.target.dataset.id;
                    if (confirm('Are you sure you want to unfollow this friend?')) {
                        await updateDoc(userRef, { friends: friendsIds.filter(id => id !== fid) });
                        loadFriendsList(uid); // refresh list
                    }
                });
            });
        }

        // Unfollow user
        async function unfollowUser(uid, friendId) {
            try {
                const userRef = doc(db, 'Users', uid);
                const userSnap = await getDoc(userRef);

                if (userSnap.exists()) {
                    const following = userSnap.data().following || [];
                    const updatedFollowing = following.filter(id => id !== friendId);

                    await updateDoc(userRef, {
                        following: updatedFollowing
                    });

                    // Reload friends list
                    await loadFriendsList(currentUser.uid);
                    alert('User unfollowed successfully!');
                }
            } catch (err) {
                console.error('Error unfollowing user:', err);
                alert('Error unfollowing user. Please try again.');
            }
        }
    </script>
</body>

</html>