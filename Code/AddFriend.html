<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find Friends — 404TicketsFound</title>
  <link rel="stylesheet" href="css/homepage.css">
  <script src="JS/nav.js" defer></script>

  <style>
    .friend-card-listed {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 10px;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
    }

    .card.friend-card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .btn-primary,
    .btn-secondary {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-primary {
      background-color: #0a66c2;
      color: #fff;
    }

    .btn-secondary {
      background-color: #ccc;
    }
  </style>
</head>

<body>
  <header>
    <div class="container header-content">
      <h1 class="logo"><a href="index.html">404TicketsFound</a></h1>
      <nav>
        <a href="SearchResults.html">Search</a>
        <a href="AddFriend.html">Add Friend</a>
      </nav>
    </div>
  </header>

  <main class="content" style="display:flex; flex-direction:column; min-height:100vh;">
    <section class="container section" id="find-friend">
      <h2 class="section-title">Find Friend</h2>
      <div class="friend-search" style="display:flex;gap:8px;align-items:center;">
        <input id="friendQuery" type="search" placeholder="Search by name..."
          style="flex:1;padding:8px;border-radius:8px;border:1px solid #ccc;">
        <button id="friendSearchBtn" class="btn-primary">Search</button>
      </div>
    </section>

    <section class="container section suggested-block">
      <h3 class="section-title">Suggested Friends</h3>
      <div id="suggestedFriends" class="suggested-list"></div>
    </section>

    <section class="container section">
      <h3 class="section-title">My Friends</h3>
      <div id="myFriendsList" class="suggested-list"></div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 404TicketsFound. All rights reserved.</p>
  </footer>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
      authDomain: "found-5ecc0.firebaseapp.com",
      projectId: "found-5ecc0",
      storageBucket: "found-5ecc0.appspot.com",
      messagingSenderId: "160156481057",
      appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Add friend function
    async function followUser(targetUID, btnElement) {
      const currentUser = auth.currentUser;
      if (!currentUser) {
        alert("You must be logged in to add a friend.");
        return;
      }
      const userRef = doc(db, "Users", currentUser.uid);
      await updateDoc(userRef, {
        friends: arrayUnion(targetUID)
      });
      if (btnElement) {
        btnElement.disabled = true;
        btnElement.textContent = "Following";
      }
    }

    // Fetch all users with last event attended
    async function getAllUsers() {
      const usersCol = collection(db, "Users");
      const querySnapshot = await getDocs(usersCol);
      const users = [];
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        users.push({
          uid: docSnap.id,
          name: data.name || "Unnamed",
          event: (data.eventsAttended && data.eventsAttended.length > 0)
            ? data.eventsAttended[data.eventsAttended.length - 1].event
            : "No recent event"
        });
      });
      return users;
    }

    async function loadMyFriends() {
  if (!auth.currentUser) {
    myFriendsEl.innerHTML = "<p class='muted'>Please log in to see your friends.</p>";
    return;
  }

  // Load current user's friends list
  const meSnap = await getDoc(doc(db, "Users", auth.currentUser.uid));
  const myFriends = meSnap.exists() ? (meSnap.data().friends || []) : [];

  if (myFriends.length === 0) {
    myFriendsEl.innerHTML = "<p class='muted'>You have no friends added yet.</p>";
    return;
  }

    myFriendsEl.innerHTML = "";

    // Fetch all users and filter by friend list
    const usersCol = collection(db, "Users");
    const querySnapshot = await getDocs(usersCol);

    querySnapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (myFriends.includes(docSnap.id)) {
        const eventName =
          data.eventsAttended && data.eventsAttended.length > 0
            ? data.eventsAttended[data.eventsAttended.length - 1].event
            : "No recent event";

        const card = document.createElement("div");
        card.className = "card friend-card";
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <strong>${data.name || "Unnamed"}</strong>
              <div style="color:#666;font-size:0.95rem;">Last event: ${eventName}</div>
            </div>
          </div>
        `;

        myFriendsEl.appendChild(card);
      }
    });
  }
    const myFriendsEl = document.getElementById('myFriendsList');
    document.addEventListener('DOMContentLoaded', () => {
      const suggestedEl = document.getElementById('suggestedFriends');
      const queryEl = document.getElementById('friendQuery');
      const btn = document.getElementById('friendSearchBtn');
      let allUsers = [];

      // Render user cards
      async function renderSuggested(users) {
        suggestedEl.innerHTML = '';
        if (users.length === 0) {
          suggestedEl.innerHTML = '<p class="muted">No users found.</p>';
          return;
        }

        users.forEach(user => {
          const card = document.createElement('div');
          card.className = 'card friend-card';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <div>
                <strong>${user.name}</strong>
                <div style="color:#666;font-size:0.95rem;">Last event: ${user.event}</div>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn-primary btn-add">Add</button>
                <button class="btn-secondary btn-view">View</button>
              </div>
            </div>
          `;

          const addBtn = card.querySelector('.btn-add');
          const viewBtn = card.querySelector('.btn-view');

          addBtn.addEventListener('click', async () => {
            await followUser(user.uid, addBtn);
          });

          viewBtn.addEventListener('click', () => {
            alert(user.name + " — past event: " + user.event);
          });

          // *** FIX #1: Persistent Following State ***
          if (auth.currentUser) {
            getDoc(doc(db, "Users", auth.currentUser.uid)).then(userSnap => {
              const following = userSnap.exists() ? (userSnap.data().friends || []) : [];
              if (following.includes(user.uid)) {
                addBtn.disabled = true;
                addBtn.textContent = "Following";
              }
            });
          } else {
            addBtn.disabled = true;
            addBtn.textContent = "Login to Add";
          }

          suggestedEl.appendChild(card);
        });
      }

      // Perform search
      async function performSearch() {
        const searchText = queryEl.value.trim().toLowerCase();
        const filtered = allUsers.filter(u => u.name.toLowerCase().includes(searchText));
        renderSuggested(filtered);
      }

      btn.addEventListener('click', performSearch);
      queryEl.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); performSearch(); }
      });

      // *** FIX #2: Wait for Firebase Auth before rendering ***
      onAuthStateChanged(auth, async user => {
        allUsers = await getAllUsers();
        renderSuggested(allUsers);
        loadMyFriends();
      });

    });
  </script>
</body>
</html>