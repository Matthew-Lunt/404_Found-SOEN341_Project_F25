<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Details ‚Äî 404TicketsFound</title>
  <link rel="stylesheet" href="css/homepage.css" />

  <style>
    .event-card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    .friend-pill {
      display: inline-block;
      background: #f0f2ff;
      border: 1px solid #d0d4ff;
      padding: 6px 10px;
      border-radius: 999px;
      margin: 4px 6px 0 0;
      font-size: 0.9rem;
    }

    #mapFrame {
      width: 100%;
      height: 300px;
      border: 0;
      border-radius: 12px;
      margin-top: 10px;
    }

    .map-btn {
      margin-top: 10px;
      padding: 10px 16px;
      border-radius: 8px;
      background: #0a66c2;
      color: white;
      border: none;
      cursor: pointer;
      display: inline-block;
    }
  </style>
</head>
<body>

<header>
  <div class="container header-content">
    <h1 class="logo"><a href="index.html">404TicketsFound</a></h1>
    <nav>
      <a href="SearchResults.html">Search</a>
      <a href="AddFriend.html">Add Friend</a>
    </nav>
  </div>
</header>

<section class="container" style="max-width: 750px; margin-top: 20px;">

  <!-- event info card -->
  <div class="event-card">
    <h2 id="name"></h2>
    <p id="loc"></p>
    <p id="org"></p>
    <p id="date"></p>
    <p id="price"></p>
  </div>

  <!-- friends attending card -->
  <div class="event-card">
    <h3>üßë‚Äçü§ù‚Äçüßë Friends Attending</h3>
    <p id="friendsSummary" style="margin-bottom:10px; color:#666;">Loading friends...</p>
    <ul id="friendsList" style="list-style:none; padding-left:0; margin:0;"></ul>
  </div>

  <!-- map card -->
  <div class="event-card">
    <h3>üìç Location Map</h3>
    <iframe id="mapFrame" loading="lazy" allowfullscreen></iframe>
    <button id="openMapsBtn" class="map-btn">Open in Google Maps</button>
  </div>

  <!-- back button -->
  <button onclick="history.back()" class="btn-secondary">‚¨Ö Back</button>

</section>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCdycuLXCIq2xr5zk2Snbw4cihQUR5vjY4",
    authDomain: "found-5ecc0.firebaseapp.com",
    projectId: "found-5ecc0",
    storageBucket: "found-5ecc0.appspot.com",
    messagingSenderId: "160156481057",
    appId: "1:160156481057:web:92b9f5569cdd89b0f3d560"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const p = new URLSearchParams(location.search);
  const eventName = p.get("event");

  const nameEl = document.getElementById("name");
  const locEl = document.getElementById("loc");
  const orgEl = document.getElementById("org");
  const dateEl = document.getElementById("date");
  const priceEl = document.getElementById("price");
  const mapFrame = document.getElementById("mapFrame");
  const openMapsBtn = document.getElementById("openMapsBtn");

  const friendsSummaryEl = document.getElementById("friendsSummary");
  const friendsListEl = document.getElementById("friendsList");

  const fmtYMD = (s) => {
    if (!s) return "Not specified";
    const [y, m, d] = s.split("-").map(Number);
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    return `${months[(m || 1) - 1]} ${String(d || 1).padStart(2,"0")}, ${y}`;
  };

  async function loadEvent() {
    try {
      const eventsCol = collection(db, "events");
      const snapshot = await getDocs(eventsCol);

      const allEvents = snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: docSnap.id,
          name: data.description || "Unnamed Event",
          location: data.location || "TBA",
          organization: data.organization || "Organizer",
          date: data.date || "",
          price: Number(data.price) || 0
        };
      });

      const ev = allEvents.find(e => e.name === eventName);

      if (!ev) {
        nameEl.textContent = eventName || "Event not found";
        locEl.textContent  = "üìç Unknown location";
        orgEl.textContent  = "üè¢ Organizer: Unknown";
        dateEl.textContent = "üìÖ Date: Not specified";
        priceEl.textContent= "üíµ Price: Not specified";
        mapFrame.src = "";
        openMapsBtn.disabled = true;
        friendsSummaryEl.textContent = "No friends attending yet.";
        return;
      }

      // Fill event info
      nameEl.textContent = ev.name;
      const locationText = ev.location || "TBA";
      locEl.textContent  = "üìç " + locationText;
      orgEl.textContent  = "üè¢ " + ev.organization;
      dateEl.textContent = "üìÖ " + (ev.date ? fmtYMD(ev.date) : "Not specified");
      priceEl.textContent= "üíµ " + (ev.price === 0 ? "Free" : `$${ev.price}`);

      // Map setup
      const mapURL = "https://www.google.com/maps?q=" + encodeURIComponent(locationText) + "&output=embed";
      mapFrame.src = mapURL;
      openMapsBtn.onclick = () => {
        window.open("https://www.google.com/maps?q=" + encodeURIComponent(locationText), "_blank");
      };

      // --- Load friends attending ---
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          friendsSummaryEl.textContent = "Login to see which friends are attending.";
          friendsListEl.innerHTML = "";
          return;
        }

        const userSnap = await getDoc(doc(db, "Users", user.uid));
        const friendsIds = userSnap.data().friends || [];

        if (friendsIds.length === 0) {
          friendsSummaryEl.textContent = "You have no friends added yet.";
          friendsListEl.innerHTML = "";
          return;
        }

        const friendsData = [];
        for (const fid of friendsIds) {
          const friendSnap = await getDoc(doc(db, "Users", fid));
          if (friendSnap.exists()) {
            const friend = friendSnap.data();
            const eventsAttended = friend.eventsAttended || [];
            const attended = eventsAttended.some(e => (e.event || "") === ev.name);
            if (attended) friendsData.push(friend.name);
          }
        }

        if (friendsData.length === 0) {
          friendsSummaryEl.textContent = "No friends attending yet.";
          friendsListEl.innerHTML = "";
        } else {
          friendsSummaryEl.textContent =
            friendsData.length === 1
              ? `${friendsData[0]} is attending`
              : `${friendsData.length} friends are attending`;

          friendsListEl.innerHTML = friendsData.map(f => `<li class="friend-pill">${f}</li>`).join("");
        }
      });

    } catch (err) {
      console.error("Error loading event:", err);
      nameEl.textContent = "Error loading event";
      friendsSummaryEl.textContent = "";
    }
  }

  loadEvent();
</script>
</body>
</html>